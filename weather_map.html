<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather Map</title>

    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

</head>
<!--TODO: Make look nicer-->
<body>
    <!--Nav Header-->
    <nav class="navbar bg-primary">
        <a class="navbar-brand text-white" href="#">Weather App</a>
        <span class="navbar-text text-white currentCity">Current City: San Antonio</span>
    </nav>

    <div class="container-fluid">
        <!--Search for Place-->
        <div class="row p-3">
            <div class="col">
                <form id="city-search">
                    <label for="city">Place</label>
                    <input type="text" id="city" name="city">
                    <input type="submit" value="Submit">
                </form>
            </div>
        </div>

        <!--Weather Conditions-->
        <div class="row no-gutters p-2">
            <div class="col">
                <div class="card-group">
                    <div class="card" id="card1"></div>
                    <div class="card" id="card2"></div>
                    <div class="card" id="card3"></div>
                    <div class="card" id="card4"></div>
                    <div class="card" id="card5"></div>
                </div>
            </div>
        </div>

        <!--Map-->
        <div class="row no-gutters">
            <div class="col">
                <div id='map' style='width: 98vw; height: 30vw'></div>
            </div>
        </div>
    </div>

<script src="./js/jquery.js"></script>
<script src="./js/keys.js"></script>
<script src="./js/mapbox-geocoder-utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

<!--Start of JS-->
<script>
  "use strict"

  $(document).ready(function (){

    //generate weather info
    $.get(`https://api.openweathermap.org/data/2.5/onecall`,{
      appid: openWeatherAPIkey,
      lat: 29.424349,
        lon: -98.491142,
        units: "imperial"
    }).done(function(data){
       weatherInfo(data, 0);
        console.log(data);
      });

    //generate map
      mapboxgl.accessToken = mapboxAPIkey;
      var map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v9',
          zoom: 10,
          center: [-98.4916, 29.4252]
      });

      //display marker for San Antonio, marker is draggable
      var marker = new mapboxgl.Marker({
          draggable: true
      })
       //intially set marker to center in SA
          .setLngLat([-98.4916, 29.4252])
          .addTo(map)

      // get daily forecast & display
      //TODO: add weather icons (description)
      function weatherInfo(data){
          data.daily.forEach(function(day, index){
              if(index < 5){
                  new Date
                  let filler1 = "<p>" + (new Date(day.dt * 1000).toDateString()) + "</p><p>Temperature: "+ day.temp.day +
                      "</p><p>Description: " + day.weather[0].description + "</p><p>Humidity: " + day.humidity +
                      "</p><p>Wind: " + day.wind_gust + "</p><p>Pressure: " +  day.pressure+"</p>";
                  $("#card" + (index + 1)).html(filler1);
              }
          })
      };

      //submit button clicked
      $("#city-search").submit(function(event) {
          event.preventDefault();
          let newCity = $("#city").val();
          reCenter(newCity);
          displaySearchCity(newCity);
      });

      // Geocode to take user input and recenter map to where they type in & updates marker & updates weather
     function reCenter(location){
         geocode(location, mapboxgl.accessToken).then(function(result) {
             //set long and lat as hard numbers
             let latitiude = result[0];
             let longitude = result[1];

             //fly map center to user input
             map.flyTo({
                 center: [
                     latitiude,
                     longitude
                 ],
                 essential: true
             });
             marker.setLngLat(result);

             //call to update weather
             newInfo(longitude, latitiude);
         })
     };

      //display current city in (TODO: get city from geocaching instead of user input)
       function displaySearchCity(data){
            let cityArray = data.split(",");
            $(".currentCity").html("Current City: " + cityArray[0]);
      }

      //TODO:marker updates current city
      //upon dragging, marker coordinates update map center & weather
      function markerDragged(){
          //set long and lat as hard numbers
          let newCoordinates = marker.getLngLat();
          let longitude = newCoordinates.lng;
          let latitude = newCoordinates.lat;

          //fly map center to where marker dropped
          map.flyTo({
              center: [
                  longitude,
                  latitude
              ],
              essential: true
          });

          //call to update weather
          newInfo(latitude, longitude);
      }
      marker.on("dragend", markerDragged);

      //set new forecast
      function newInfo(lat, long){
          $.get(`https://api.openweathermap.org/data/2.5/onecall`,{
              appid: openWeatherAPIkey,
              lat: lat,
              lon: long,
              units: "imperial"
          }).done(function(data){
              weatherInfo(data, 0);
              console.log(data);
          })
      }

  //last closing bracket
  });
</script>
</body>
</html>